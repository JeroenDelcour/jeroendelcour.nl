<html>
<head>
	<meta charset="utf-8">
	<title>How Twitter feels about the presidential candidates</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name='author' content="Jeroen Delcour">
	<link rel="stylesheet" href="style.css">
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-22518982-6', 'auto');
		ga('send', 'pageview');
	</script>
	<script src="http://d3js.org/d3.v3.min.js"></script>
</head>
<body>

<main>

<h1>How Twitter feels about the 2016 USA presidential candidates</h1>
<h2>Live sentiment analysis on the public Twitter stream (updates every 10 minutes)</h2>

<figure class="plotContainer">
	<div id="legend">
		<span class="label Sanders">• Sanders</span>
		<span class="label Trump">• Trump</span>
		<span class="label Clinton">• Clinton</span>
		<span class="label Cruz">• Cruz</span>
	</div>
	<svg id="yAxis">
	<div id="plot">
		<svg id="sentiment" width="1000" height="300"></svg>
		<svg id="tweetsPerSecond" width="1000" height="150"></svg>
	</div>
	</svg>
</figure>

<a href="https://github.com/JeroenDelcour/SentimentalWorld" target="_blank" class="github">source</a>

</main>

<script>

d3.csv('data_cruz_downsampled.csv', function(error, data) {

	data.forEach(function(d) {
		d.date = new Date(+d.date*1000);
		if (d.mood.length > 0) {
			d.mood = +d.mood;
		} else {
			d.mood = null;
		}
		d.tweets = +d.tweets
	});

	pixelsPerDatapoint = 2
	viewLengthPixels = pixelsPerDatapoint * data.length;

	var WIDTH = viewLengthPixels,
		HEIGHT = 300,
		MARGINS = {
			top: 20,
			right: 20,
			bottom: 20,
			left: 50
		}

	var vis = d3.select("#sentiment")
	var tps = d3.select("#tweetsPerSecond")
	var yAxisEl = d3.select('#yAxis');

	var plot = document.getElementById("sentiment");
	plot.setAttribute("width", viewLengthPixels);
	document.getElementById("tweetsPerSecond").setAttribute("width", viewLengthPixels);

	document.getElementById("plot").scrollLeft = viewLengthPixels;

	var xScale = d3.time.scale()
		.domain([
		  data[0].date,
		  new Date()
		])
		.range([0, WIDTH - MARGINS.right]);

	var yScale = d3.scale.linear()
		.domain([-0.5, 0.5])
		.range([HEIGHT - MARGINS.top, 0]); // Seems backwards because SVG is y-down

	var yScaleTps = d3.scale.linear()
		.domain([0, 10])
		.range([150 - MARGINS.bottom, 0])

	var xAxis = d3.svg.axis()
		.scale(xScale)         // x is the d3.time.scale()
		.orient('top') // the ticks go above the graph
		.ticks(viewLengthPixels / 100);        // specify the number of ticks

	var yAxis = d3.svg.axis()
		.scale(yScale)
		.orient('left')
		.ticks(5);

	var yAxisTps = d3.svg.axis()
		.scale(yScaleTps)
		.orient('left')
		.ticks(5)

	var lineGen = d3.svg.line()
		.defined(function(d){ return d.mood; })
		.x(function(d) {
			return xScale(d.date);
		})
		.y(function(d) {
			return yScale(d.mood);
		})
		.interpolate("basis");

	var lineGenTps = d3.svg.line()
		.defined(function(d){ return d.mood; })
		.x(function(d) {
			return xScale(d.date);
		})
		.y(function(d) {
			return yScaleTps(d.tweets / 10 / 60);
		})
		.interpolate("basis");

	vis.append('line')
		.attr({ x1: 0, y1: yScale(0), x2: viewLengthPixels, y2: yScale(0) })
		.style("stroke-dasharray", ("5, 5"))
		.style("stroke", "#CCC");

	vis.append('g')            // create a <g> element
		.attr("class","axis")
		.attr("transform", "translate(0," + (MARGINS.top) + ")")
		.call(xAxis);            // let the axis do its thing

	yAxisEl.append('g')            // create a <g> element
		.attr("class","axis")
		.attr("transform", "translate(" + (MARGINS.left) + ",0)")
		.call(yAxis);            // let the axis do its thing

	yAxisEl.append("text")
		.attr("class", "y label")
		.attr("text-anchor", "middle")
		.attr("y", MARGINS.left - 45)
		.attr("x", -HEIGHT/2)
		.attr("dy", ".75em")
		.attr("transform", "rotate(-90)")
		.text("Sentiment");

	yAxisEl.append('g')
		.attr("class","axis")
		.attr("transform", "translate(" + (MARGINS.left) + "," + (HEIGHT) + ")")
		.call(yAxisTps);

	yAxisEl.append("text")
		.attr("class", "y label")
		.attr("text-anchor", "middle")
		.attr("y", MARGINS.left - 45)
		.attr("x", -HEIGHT - (150/2))
		.attr("dy", ".75em")
		.attr("transform", "rotate(-90)")
		.text("Tweets per second");

	vis.append('svg:path')
		.attr('d', lineGen(data))
		.attr('stroke', 'orange')
		.attr('stroke-width', 1)
		.attr('fill', 'none');

	tps.append('svg:path')
		.attr('d', lineGenTps(data))
		.attr('stroke', 'orange')
		.attr('stroke-width', 1)
		.attr('fill', 'none')
		.style("stroke-dasharray", ("1, 1"));

	d3.csv('data_clinton_downsampled.csv', function(error, data2) {

		data2.forEach(function(d) {
			d.date = new Date(+d.date*1000);
			if (d.mood.length > 0) {
				d.mood = +d.mood;
			} else {
				d.mood = null;
			}
		});

		vis.append('svg:path')
			.attr('d', lineGen(data2))
			.attr('stroke', 'green')
			.attr('stroke-width', 1)
			.attr('fill', 'none');

		tps.append('svg:path')
			.attr('d', lineGenTps(data2))
			.attr('stroke', 'green')
			.attr('stroke-width', 1)
			.attr('fill', 'none')
			.style("stroke-dasharray", ("1, 1"));

	});

	d3.csv('data_trump_downsampled.csv', function(error, data2) {

		data2.forEach(function(d) {
			d.date = new Date(+d.date*1000);
			if (d.mood.length > 0) {
				d.mood = +d.mood;
			} else {
				d.mood = null;
			}
		d.tweets = +d.tweets
		});

		vis.append('svg:path')
			.attr('d', lineGen(data2))
			.attr('stroke', 'red')
			.attr('stroke-width', 1)
			.attr('fill', 'none');

		tps.append('svg:path')
			.attr('d', lineGenTps(data2))
			.attr('stroke', 'red')
			.attr('stroke-width', 1)
			.attr('fill', 'none')
			.style("stroke-dasharray", ("1, 1"));

	});

	d3.csv('data_sanders_downsampled.csv', function(error, data2) {

		data2.forEach(function(d) {
			d.date = new Date(+d.date*1000);
			if (d.mood.length > 0) {
				d.mood = +d.mood;
			} else {
				d.mood = null;
			}
			d.tweets = +d.tweets
		});

		vis.append('svg:path')
			.attr('d', lineGen(data2))
			.attr('stroke', 'blue')
			.attr('stroke-width', 1)
			.attr('fill', 'none');

		tps.append('svg:path')
			.attr('d', lineGenTps(data2))
			.attr('stroke', 'blue')
			.attr('stroke-width', 1)
			.attr('fill', 'none')
			.style("stroke-dasharray", ("1, 1"));

	});

	// candidates = [
	// 	{
	// 		name: 'Sanders',
	// 		color: 'blue'
	// 	},
	// 	{
	// 		name: 'Trump',
	// 		color: 'red'
	// 	},
	// 	{
	// 		name: 'Clinton',
	// 		color: 'green'
	// 	},
	// 	{
	// 		name: 'Cruz',
	// 		color: 'orange'
	// 	}
	// ]

	// yAxisEl.append('g')
	// 	.attr('class', 'legend')
	// 	.selectAll('text')
	// 	.data(candidates)
	// 	  .enter()
	// 	    .append('text')
	// 	      .text(function(d) { return '• ' + d.name; })
	// 	      .attr('class', 'legendText')
	// 	      .attr('fill', function(d) { return d.color; })
	// 	      .attr('y', function(d, i) { return MARGINS.top + (20 * (i + 1)); })
	// 	      .attr('x', MARGINS.left + 10)

});

var refreshTimer = setInterval(function(){
	location.reload();
}, 1000 * 60 * 10); // refresh every 10 minutes
</script>

</body>
</html>
